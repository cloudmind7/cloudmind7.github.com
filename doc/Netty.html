<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Netty</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><p>본문의 내용은 <strong>‘자바 네트워크 소녀 Netty - 정경석 지음’</strong> 을 바탕으로 한 학습 내용을 정리한 것입니다.</p>

<hr>



<h4 id="목차">목차</h4>

<p><a href="#1-netty">1. Netty</a> <br>
<a href="#2-설치">2. 설치</a> <br>
<a href="#3-sample-server">3. Sample Server</a> <br>
<a href="#4-sample-client">4. Sample Client</a></p>

<hr>



<h4 id="1-netty"><strong>1. Netty</strong></h4>

<p>네티는 비동기 이벤트 기반 네트워크 애플리케이션 프레임워크로써 유지보수를 고려한 고성능 프로토콜 서버와 클라이언트를 빠르게 개발할 수 있다.</p>

<p><a href="http://goo.gl/v8UVyC">얼마나 성능이 좋길래?</a></p>

<h5 id="생각해볼문제">생각해볼문제</h5>

<blockquote>
  <ul>
  <li>sync Vs async</li>
  <li><a href="https://github.com/krisjey/netty.book.kor/blob/master/example/src/java/com/github/nettybook/ch2/BlockingServer.java">blocking</a> Vs <a href="https://github.com/krisjey/netty.book.kor/blob/master/example/src/java/com/github/nettybook/ch2/NonBlockingServer.java">non-blocking</a></li>
  <li>event-driven</li>
  </ul>
</blockquote>

<p><a href="#목차">- Top</a></p>

<hr>



<h4 id="2-설치"><strong>2. 설치</strong></h4>

<ol>
<li><a href="http://netty.io">공식사이트(http://netty.io)</a>의 Downloads 메뉴에서 설치 파일을 다운로드</li>
<li>다운로드한 파일의 압축을 풀고 jar 폴더 안에 있는 jar 파일의 일부를 선택해서 사용하거나, all-in-one 폴더 에 있는 묶음 파일을 사용</li>
<li>메이븐과 같은 서드파티 프로그램 으로도 설치가 가능</li>
</ol>

<p><a href="#목차">- Top</a></p>

<hr>

<h4 id="3-sample-server"><strong>3. Sample Server</strong></h4>

<p><strong>초기화 순서</strong>:</p>

<div class="sequence-diagram"><svg height="300" version="1.1" width="864.8500099182129" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative;"><desc>Created with Raphaël 2.1.2</desc><defs><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block"></path><marker id="raphael-marker-endblock55-obj46" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use xlink:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj49" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use xlink:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj52" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use xlink:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker><marker id="raphael-marker-endblock55-obj55" markerHeight="5" markerWidth="5" orient="auto" refX="2.5" refY="2.5"><use xlink:href="#raphael-marker-block" transform="rotate(180 2.5 2.5) scale(1,1)" stroke-width="1.0000" fill="#000" stroke="none"></use></marker></defs><rect x="10" y="20" width="98.03333282470703" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="20" y="30" width="78.03333282470703" height="20" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="59.016666412353516" y="40" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="5">이벤트 루프</tspan></text><rect x="10" y="240" width="98.03333282470703" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="20" y="250" width="78.03333282470703" height="20" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="59.016666412353516" y="260" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="5">이벤트 루프</tspan></text><path style="" fill="none" stroke="#000000" d="M59.016666412353516,60L59.016666412353516,240" stroke-width="2"></path><rect x="170.05000686645508" y="20" width="95" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="180.0500030517578" y="32" width="75" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="217.55000686645508" y="40" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">부트스트랩</tspan></text><rect x="170.05000686645508" y="240" width="95" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="180.0500030517578" y="252" width="75" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="217.55000686645508" y="260" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">부트스트랩</tspan></text><path style="" fill="none" stroke="#000000" d="M217.55000686645508,60L217.55000686645508,240" stroke-width="2"></path><rect x="344.6333351135254" y="20" width="50" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="354.6333312988281" y="32" width="30" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="369.6333351135254" y="40" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">채널</tspan></text><rect x="344.6333351135254" y="240" width="50" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="354.6333312988281" y="252" width="30" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="369.6333351135254" y="260" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">채널</tspan></text><path style="" fill="none" stroke="#000000" d="M369.6333351135254,60L369.6333351135254,240" stroke-width="2"></path><rect x="544.733341217041" y="20" width="125" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="554.7333374023438" y="32" width="105" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="607.233341217041" y="40" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">채널파이프라인</tspan></text><rect x="544.733341217041" y="240" width="125" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="554.7333374023438" y="252" width="105" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="607.233341217041" y="260" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">채널파이프라인</tspan></text><path style="" fill="none" stroke="#000000" d="M607.233341217041,60L607.233341217041,240" stroke-width="2"></path><rect x="769.8500099182129" y="20" width="65" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="779.8500366210938" y="32" width="45" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="802.3500099182129" y="40" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">핸들러</tspan></text><rect x="769.8500099182129" y="240" width="65" height="40" rx="0" ry="0" fill="none" stroke="#000000" style="" stroke-width="2"></rect><rect x="779.8500366210938" y="252" width="45" height="16" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="802.3500099182129" y="260" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="7">핸들러</tspan></text><path style="" fill="none" stroke="#000000" d="M802.3500099182129,60L802.3500099182129,240" stroke-width="2"></path><rect x="69.01667022705078" y="75" width="138.53334045410156" height="20" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="138.2833366394043" y="85" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="5">Bootstrap.group(l1,l2)</tspan></text><path style="" fill="none" stroke="#000000" d="M59.016666412353516,100C59.016666412353516,100,185.59602352303045,100,212.54358197042066,100" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj46)" stroke-dasharray="0"></path><rect x="227.5500030517578" y="115" width="132.0833282470703" height="20" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="293.59167098999023" y="125" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="5">Bootstrap.channel(c)</tspan></text><path style="" fill="none" stroke="#000000" d="M217.55000686645508,140C217.55000686645508,140,338.3829567999319,140,364.6381632063758,140" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj49)" stroke-dasharray="0"></path><rect x="379.5250244140625" y="155" width="217.60000610351562" height="20" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="488.4333381652832" y="165" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="5">ChannelInitializer-&gt;initChannel(sc)</tspan></text><path style="" fill="none" stroke="#000000" d="M369.6333351135254,180C369.6333351135254,180,567.9915401034182,180,602.2296384744764,180" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj52)" stroke-dasharray="0"></path><rect x="617.125" y="195" width="175.11666870117188" height="20" rx="0" ry="0" fill="#ffffff" stroke="none" style=""></rect><text style="text-anchor: middle; font-family: Andale Mono,monospace; font-size: 16px;" x="704.791675567627" y="205" text-anchor="middle" font-family="Andale Mono, monospace" font-size="16px" stroke="none" fill="#000000"><tspan dy="5">ChannelPipeline.addLast(h)</tspan></text><path style="" fill="none" stroke="#000000" d="M607.233341217041,220C607.233341217041,220,766.8767164455476,220,797.3555053685682,220" stroke-width="2" marker-end="url(#raphael-marker-endblock55-obj55)" stroke-dasharray="0"></path></svg></div>

<ul>
<li>EchoServer.java</li>
</ul>



<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span>, <span class="hljs-keyword">import</span> 생략...

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(String[] args) <span class="hljs-keyword">throws</span> Exception {
        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);
        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();
        <span class="hljs-keyword">try</span> {
            ServerBootstrap b = <span class="hljs-keyword">new</span> ServerBootstrap();
            b.group(bossGroup, workerGroup)
            .channel(NioServerSocketChannel.class)
            .handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO))
            .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
                <span class="hljs-annotation">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span>(SocketChannel ch) {
                    ChannelPipeline p = ch.pipeline();
                    p.addLast(<span class="hljs-keyword">new</span> EchoServerHandler());
                }
            });
            ChannelFuture f = b.bind(<span class="hljs-number">8888</span>).sync();
            f.channel().closeFuture().sync();
        }
        <span class="hljs-keyword">finally</span> {
            worderGroup.shutdownGracefully();
            bossGroup.shutdownGracefully();
        }   
    }

}</code></pre>

<dl>
<dt>부트스트랩 의 논리적 구조</dt>
<dd>전송 계층 (소켓 모드 및 I/O 종류)</dd>

<dd>이벤트 루프 (단일 스레드, 다중 스레드)</dd>

<dd>채널 파이프라인 설정</dd>

<dd>소켓 주소와 포트</dd>

<dd>소켓 옵션</dd>
</dl>

<blockquote>
  <p><strong>[Bootstrap의 주요 API]</strong> <br>
  <strong>channel</strong> : 소켓 입출력 모드 설정<a href="#fn:channel" id="fnref:channel" title="See footnote" class="footnote">1</a> <br>
  <strong>channelFactory</strong> : 소켓 입출력 모드 설정 <br>
  <strong>handler</strong> : 서버 소켓 채널의 이벤트 핸들러 설정 <br>
  <strong>childHandler</strong> : 소켓 채널의 데이터 가공 핸들러 설정 <br>
  <strong>option</strong> : 서버 소켓 채널의 소켓 옵션 설정 <br>
  <strong>childOption</strong> : 소켓 채널의 소켓 옵션 설정</p>
  
  <p><strong>[memo]</strong> <br>
  <strong>NioEventLoopGroup</strong> : 클래스의 인수 없는 생성자는 사용할 스레드 수를 서버 애플리케이션이 동작하는 하드웨어 코어 수를 기준으로 결정한다. 스레드 수는 하드웨어가 가지고 있는 CPU 코어 수의 2배를 사용한다. 만약 서버가 4코어 CPU 이고 하이퍼 쓰레딩을 지원한다면 스레드는 16개가 생성된다.</p>
</blockquote>

<ul>
<li>EchoServerHandler.java</li>
</ul>



<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span>, <span class="hljs-keyword">import</span> 생략...

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> {</span>

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span>(ChannelHandlerContext ctx, Object msg) {
        String readMessage = ((ByteBuf) msg).toString(Charset.defaultCharset());
        System.out.println(<span class="hljs-string">"수신한 문자열 ["</span> + readMessage + <span class="hljs-string">']'</span>);
        ctx.write(msg);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelReadComplete</span>(ChannelHandlerContext ctx) {
        ctx.flush();
    }

    ... 생략 ...
}
</code></pre>

<blockquote>
  <p><strong>ChannelInboundHandlerAdapter</strong> : 입력된 데이터를 처리하는 이벤트 핸들러 <br>
  <strong>channelRead</strong> : 데이터의 수신이 이뤄졌을때 네티가 자동 호출 <br>
  <strong>ChannelHandlerContext </strong> : 채널 파이프라인에 대한 이벤트를 처리 <br>
  <strong>channelReadComplete</strong> : channelRead 이벤트 종료 후 자동 호출</p>
</blockquote>

<p><a href="#목차">- Top</a></p>

<hr>



<h4 id="4-sample-client"><strong>4. Sample Client</strong></h4>

<ul>
<li>EchoClient.java</li>
</ul>

<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span>, <span class="hljs-keyword">import</span> 생략...

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoClient</span> {</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(String[] args) <span class="hljs-keyword">throws</span> Exception {
        EventLoopGroup group = <span class="hljs-keyword">new</span> NioEventLoopGroup();

        <span class="hljs-keyword">try</span> {
            Bootstrap b = <span class="hljs-keyword">new</span> Bootstrap();
            b.group(group)
            .channel(NioSocketChannel.class)
            .handler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() {
                <span class="hljs-annotation">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span>(SocketChannel ch) <span class="hljs-keyword">throws</span> Exception {
                    ChannelPipeline p = ch.pipeline();
                    p.addLast(<span class="hljs-keyword">new</span> EchoClientHandler());
                }
            });
        }
        <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }

}</code></pre>

<ul>
<li>EchoClient.java</li>
</ul>



<pre class="prettyprint"><code class="language-java hljs "><span class="hljs-keyword">package</span>, <span class="hljs-keyword">import</span> 생략...

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EchoClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> {</span>

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span>(ChannelHandlerContext ctx) {
        String sendMessage = <span class="hljs-string">"Hello, Netty!"</span>;

        ByteBuf messageBuffer = Unpooled.buffer();
        messageBuffer.writeBytes(sendMessage.getBytes());

        StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder();
        builder.append(<span class="hljs-string">"전송할 문자열 ["</span>);
        builder.append(sendMessage);
        builder.append(<span class="hljs-string">"]"</span>);

        System.out.println(builder.toString());
        ctx.writeAndFlush(messageBuffer);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span>(ChannelHandlerContext ctx, Object msg) {
        String readMessage = ((ByteBuf)msg).toString(Charset.defaultCharset());

        StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder();
        builder.append(<span class="hljs-string">"수신한 문자열 ["</span>);
        builder.append(readMessage);
        builder.append(<span class="hljs-string">"]"</span>);
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelReadComplete</span>(ChannelHandlerContext ctx) {
        ctx.close();
    }

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span>(ChannelHandlerContext ctx, Throwable cause) {
        cause.printStackTrace();
        ctx.close();
    }

}</code></pre>

<blockquote>
  <p><strong>channelActive</strong> :  소켓 채널이 최초 활성화 되었을 때 실행 <br>
  <strong>ctx.close()</strong> : 서버와 연결된 채널을 닫는다. 이후 데이터 송수신 채널은 닫히게 되고 클라이언트 프로그램은 종료된다</p>
</blockquote>

<p><a href="#목차">- Top</a></p>

<hr>



<h4 id="부트스트랩">부트스트랩</h4>

<hr>



<h4 id="채널-파이프라인과-코덱">채널 파이프라인과 코덱</h4>

<hr>



<h4 id="이벤트-모델">이벤트 모델</h4>

<hr>



<h4 id="바이트-버퍼">바이트 버퍼</h4>

<hr>



<h4 id="netty-관련-링크">Netty 관련 링크</h4>

<p><a href="https://github.com/netty">- Netty Github</a> <br>
<a href="http://www.bloter.net/archives/11472">- Netty 이희승</a> <br>
<a href="https://groups.google.com/forum/#!forum/netty-ko">- Netty Korean User Group</a></p>

<div class="footnotes"><hr><ol><li id="fn:channel">소켓 채널의 종류 <br>
LocalChannel.class <br>
OioSocketChannel.class <br>
NioSocketChannel.class <br>
EpollSocketChannel.class <br>
OioSctpChannel.class <br>
NioSctpChannel.class <a href="#fnref:channel" title="Return to article" class="reversefootnote">↩</a></li></ol></div></div></body>
</html>
