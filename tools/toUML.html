<!DOCTYPE html>
<html lang="ko">
<head>
    <title>To UML</title>
    <meta charset="UTF-8">
    <meta name="Author" content="정재욱">
</head>
<style>
    header { position:fixed;padding:5px;top:0;left:0;right:0;display:flex;background: white; }
    body { padding-top:35px;font-size:.9em;font-family:Arial,Dotum,"돋움",sans-serif; }
    hr { height:1px;background-color:#bebebe;border:none; }
    .checkDepth { position:relative;padding-top:9px;padding-left:35px;margin-bottom:12px;cursor:pointer;font-size:12px; }
    .checkDepth input { position:absolute;opacity:0;cursor:pointer;height:0;width:0; }
    .checkmark { position:absolute;top:0;left:0;font-size:.6em;line-height:27px;height:28px;width:28px;background-color:white;border:1px solid rgb(118, 118, 118); }
    .checkDepth input:checked ~ .checkmark { background-color:rgb(116, 216, 255); }
    .srch_dev { display:block; position:relative; }
    .select { height:30px;padding-left:5px;padding-right:5px; }
    .input { height:30px;width:300px;padding:0;margin:0;vertical-align: middle; }
    .btn { height:30px;cursor:pointer; position:absolute }
    .execBtn { margin-left: 5px }
    .resetBtn { margin-left: 53px }
    .sampleBtn { margin-left: 115px }
    .view { padding:10px }
    .view pre { line-height:20px; }
    .ttl { font-size:1em; font-weight: bold; }
</style>
<body>
<header>
    <div class="srch_div">
        <textarea id="dataInput" placeholder="내용을 입력해주세요." cols="80" class="input"></textarea>
        <input type="hidden" id="viewType" value="plantUML" />
        <!--
        <label for="viewType">뷰어: </label>
        <select id="viewType" class="select">
            <option>plantUML</option>
        </select>
        -->
        <label for="umlType">타입: </label>
        <select id="umlType" class="select">
            <option selected>mindmap</option>
            <option>wbs</option>
            <option>json</option>
        </select>
        <label for="umlScale">크기: </label>
        <select id="umlScale" class="select">
            <option value="8">1</option>
            <option value="10">2</option>
            <option value="12" selected>3</option>
            <option value="14">4</option>
            <option value="16">5</option>
            <option value="18">6</option>
            <option value="20">7</option>
            <option value="25">8</option>
            <option value="30">9</option>
            <option value="45">10</option>
        </select>
        <label for="nodeDepth" class="mindmap wbs">노드 레벨: </label>
        <label class="checkDepth mindmap wbs">
            <input type="checkbox" id="countDepth" checked />
            <span class="checkmark">Depth</span>
        </label>
        <select id="nodeDepth" class="select mindmap wbs">
            <option value=""> - </option>
        </select>
        <label for="showDepth" class="mindmap wbs">출력 레벨: </label>
        <select id="showDepth" class="select mindmap wbs">
            <option value=""> - </option>
        </select>

        <button id="execBtn" class="btn execBtn"> 실행 </button>
        <button id="resetBtn" class="btn resetBtn"> 초기화 </button>
        <button id="sampleBtn" class="btn sampleBtn"> 샘플데이터 </button>
    </div>
    <hr>
</header>
<main id="view" class="view"></main>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://code.jquery.com/jquery.min.js"></script>
<script src="https://cdn.rawgit.com/jmnote/plantuml-encoder/d133f316/dist/plantuml-encoder.min.js"></script>
<script type="text/babel">
    $(function() {
        $('#dataInput').change(function(){
            let isJson = false;
            try {
                JSON.parse(this.value);
                isJson = true;
            } catch(e) {}

            if (isJson) {
                $('#umlType').val('json').prop('selected', true);
                $('.mindmap').hide();
                execBtn();
            }

        });

        $('#viewType, #umlType, #umlScale, #countDepth, #nodeDepth, #showDepth').change(function(){
            const umlType = $('#umlType').val();
            if (umlType === 'json') {
                $('.mindmap').hide();
            } else {
                $('.mindmap').show();
            }

            $('#dataInput').val() && execBtn();
        });

        $('#execBtn').click(function(e, opts) {
            if (!validate()) {
                return;
            }

            const btnClicked = !opts;
            const umlType = $('#umlType').val();

            const func = {
                mindmap: () => {
                    let nodeDepth = !btnClicked && $('#nodeDepth').val() || 1;
                    let showDepth = !btnClicked && $('#showDepth').val() || Infinity;

                    const opts = {
                        inputText: '',
                        display: '#view',
                        view: {
                            type: $('#viewType').val(),
                            umlType: $('#umlType').val(),
                            umlScale: $('#umlScale').val(),
                            countDepth: $('#countDepth').is(':checked'),
                            nodeDepth,
                            showDepth
                        }
                    };

                    opts.inputText = $('#dataInput').val();
                    const data = opts.data = parseData(opts);

                    if (data && 1 < data[0].depth) {
                        alert("잘못된 데이터입니다. 문자열이 Tab으로 시작할 수 없습니다.");
                        $('#dataInput').focus();
                        return;
                    }

                    const maxDepth = data.reduce((a, b) => Math.max(a, b.depth), -Infinity);

                    if (nodeDepth > maxDepth) {
                        nodeDepth = maxDepth;
                    }

                    if (showDepth === Infinity || showDepth > maxDepth) {
                        showDepth = opts.showDepth = maxDepth;
                    }

                    const $nodeDepth = $('#nodeDepth').html('');
                    const $showDepth = $('#showDepth').html('');

                    for (let i = 1; i <= maxDepth; i++) {
                        if (i == 1 && opts.data[0].depth == 0) $nodeDepth.append($(`<option ${0 == nodeDepth? 'selected' : ''}>${0}</option>`));
                        $nodeDepth.append($(`<option ${i == nodeDepth? 'selected' : ''}>${i}</option>`));
                        $showDepth.append($(`<option ${i == showDepth? 'selected' : ''}>${i}</option>`));
                    }

                    return opts;
                },
                wbs: function(opts) {
                    return this.mindmap(opts);
                },
                json: () => {
                    return {
                    inputText: $('#dataInput').val(),
                    data: $('#dataInput').val(),
                    display: '#view',
                    view: {
                        type: $('#viewType').val(),
                        umlType: $('#umlType').val(),
                        umlScale: $('#umlScale').val()
                    }
                }}
            };
            
            const options = func[umlType]();
            viewer.show(options);
        });

        $('#resetBtn').click(function() {
            $('.mindmap').show();
            $('#dataInput').val("").css({height:"30px", width:"300px"});
            $('#viewType').val("plantUML");
            $('#umlType option:eq(0)').prop('selected', true);
            $('#umlScale option:eq(2)').prop('selected', true);
            $('#countDepth').prop('checked', true);
            $('#nodeDepth, #showDepth').html($('<option value=""> - </option>'));
            $('#view').html(`
            <pre>
            <span class="ttl">+ mindmap, wbs</span>
                . IA 정의서의 내용을 쉽게 확인하기 위해 제작했습니다. 엑셀 시트의 내용을 복사 후 상단 입력란에 넣고 '실행' 버튼을 클릭해주세요.
                . 입력한 텍스트의 Tab이 변환된 UML의 Depth 입니다.

            <span class="ttl">+ json</span>
                . Json 데이터를 시각적으로 보여줍니다.
            </pre>
        `.replace(/^[ ]+([^ ].+)/gm, '$1'));
        });

        $('#sampleBtn').click(function() {
            const umlType = $('#umlType').val();
            const data = {
                mindmap: "%EA%B3%BC%EB%AA%A9%20%EA%B4%80%EB%A6%AC%09%EB%AA%A9%EB%A1%9D%09%09%09%0A%09%09%EA%B2%80%EC%83%89%09%ED%85%8D%EC%8A%A4%ED%8A%B8%09%EA%B3%BC%EB%AA%A9%EB%AA%85%2F%EB%8B%B4%EB%8B%B9%EC%9E%90%0A%09%09%09%EA%B5%AC%EB%B6%84%09%EB%82%B4%EC%9D%BC%EB%B0%B0%EC%9B%80%EC%B9%B4%EB%93%9C%EA%B3%BC%EC%A0%95%2F%EC%9D%BC%EB%B0%98%EA%B3%BC%EC%A0%95%0A%09%09%09%EC%83%81%ED%83%9C%09%EC%A4%80%EB%B9%84%EC%A4%91%2F%EA%B5%90%EC%9C%A1%EC%A4%91%0A%09%09%09%EC%9C%A0%ED%98%95%09%EA%B0%95%EC%9D%98%ED%98%95%2C%20%EC%8B%A4%EC%8A%B5%ED%98%95%2C%20%EC%9C%B5%ED%95%A9%ED%98%95%0A%09%09%09%EB%8C%80%EB%B6%84%EB%A5%98%09%EC%8B%9C%EC%84%A4%EC%9B%90%EC%98%88%2F%EB%85%B8%EC%A7%80%2F%EC%B6%95%EC%82%B0%2F%EC%9E%84%EC%97%85%2F%EC%88%98%EC%82%B0%E2%80%A6%0A%09%09%09%EC%86%8C%EB%B6%84%EB%A5%98%09%EC%9E%AC%EB%B0%B0%2F%EC%A0%9C%EC%96%B4%2F%EB%8D%B0%EC%9D%B4%ED%84%B0%2F%EA%B2%BD%EC%98%81%E2%80%A6%0A%09%09%09%EB%82%9C%EC%9D%B4%EB%8F%84%09%EC%9E%85%EB%AC%B8%2F%EA%B8%B0%EC%B4%88%2F%EC%8B%AC%ED%99%94%20%0A%09%09%EC%8D%B8%EB%84%A4%EC%9D%BC%ED%98%95%20%EB%A6%AC%EC%8A%A4%ED%8A%B8%09%EC%8D%B8%EB%84%A4%EC%9D%BC%20%EC%9D%B4%EB%AF%B8%EC%A7%80%09%0A%09%09%09%EA%B3%BC%EB%AA%A9%EB%AA%85%09%0A%09%09%09%EA%B3%BC%EB%AA%A9%20%EA%B0%9C%EC%9A%94%09%0A%09%09%09%EB%8B%B4%EB%8B%B9%EC%9E%90%09%0A%09%09%09%EA%B5%AC%EB%B6%84%09%0A%09%09%09%EC%83%81%ED%83%9C%09%0A%09%09%09%EC%9C%A0%ED%98%95%09%0A%09%09%09%EB%8C%80%EB%B6%84%EB%A5%98%09%0A%09%09%09%EC%86%8C%EB%B6%84%EB%A5%98%09%0A%09%09%09%EB%82%9C%EC%9D%B4%EB%8F%84",
                wbs: "%EA%B3%BC%EB%AA%A9%20%EA%B4%80%EB%A6%AC%09%EB%AA%A9%EB%A1%9D%09%09%09%0A%09%09%EA%B2%80%EC%83%89%09%ED%85%8D%EC%8A%A4%ED%8A%B8%09%EA%B3%BC%EB%AA%A9%EB%AA%85%2F%EB%8B%B4%EB%8B%B9%EC%9E%90%0A%09%09%09%EA%B5%AC%EB%B6%84%09%EB%82%B4%EC%9D%BC%EB%B0%B0%EC%9B%80%EC%B9%B4%EB%93%9C%EA%B3%BC%EC%A0%95%2F%EC%9D%BC%EB%B0%98%EA%B3%BC%EC%A0%95%0A%09%09%09%EC%83%81%ED%83%9C%09%EC%A4%80%EB%B9%84%EC%A4%91%2F%EA%B5%90%EC%9C%A1%EC%A4%91%0A%09%09%09%EC%9C%A0%ED%98%95%09%EA%B0%95%EC%9D%98%ED%98%95%2C%20%EC%8B%A4%EC%8A%B5%ED%98%95%2C%20%EC%9C%B5%ED%95%A9%ED%98%95%0A%09%09%09%EB%8C%80%EB%B6%84%EB%A5%98%09%EC%8B%9C%EC%84%A4%EC%9B%90%EC%98%88%2F%EB%85%B8%EC%A7%80%2F%EC%B6%95%EC%82%B0%2F%EC%9E%84%EC%97%85%2F%EC%88%98%EC%82%B0%E2%80%A6%0A%09%09%09%EC%86%8C%EB%B6%84%EB%A5%98%09%EC%9E%AC%EB%B0%B0%2F%EC%A0%9C%EC%96%B4%2F%EB%8D%B0%EC%9D%B4%ED%84%B0%2F%EA%B2%BD%EC%98%81%E2%80%A6%0A%09%09%09%EB%82%9C%EC%9D%B4%EB%8F%84%09%EC%9E%85%EB%AC%B8%2F%EA%B8%B0%EC%B4%88%2F%EC%8B%AC%ED%99%94%20%0A%09%09%EC%8D%B8%EB%84%A4%EC%9D%BC%ED%98%95%20%EB%A6%AC%EC%8A%A4%ED%8A%B8%09%EC%8D%B8%EB%84%A4%EC%9D%BC%20%EC%9D%B4%EB%AF%B8%EC%A7%80%09%0A%09%09%09%EA%B3%BC%EB%AA%A9%EB%AA%85%09%0A%09%09%09%EA%B3%BC%EB%AA%A9%20%EA%B0%9C%EC%9A%94%09%0A%09%09%09%EB%8B%B4%EB%8B%B9%EC%9E%90%09%0A%09%09%09%EA%B5%AC%EB%B6%84%09%0A%09%09%09%EC%83%81%ED%83%9C%09%0A%09%09%09%EC%9C%A0%ED%98%95%09%0A%09%09%09%EB%8C%80%EB%B6%84%EB%A5%98%09%0A%09%09%09%EC%86%8C%EB%B6%84%EB%A5%98%09%0A%09%09%09%EB%82%9C%EC%9D%B4%EB%8F%84",
                json: "%7B%0A%20%20%22firstName%22%3A%20%22John%22%2C%0A%20%20%22lastName%22%3A%20%22Smith%22%2C%0A%20%20%22isAlive%22%3A%20true%2C%0A%20%20%22age%22%3A%2028%2C%0A%20%20%22address%22%3A%20%7B%0A%20%20%20%20%22streetAddress%22%3A%20%2221%202nd%20Street%22%2C%0A%20%20%20%20%22city%22%3A%20%22New%20York%22%2C%0A%20%20%20%20%22state%22%3A%20%22NY%22%2C%0A%20%20%20%20%22postalCode%22%3A%20%2210021-3100%22%0A%20%20%7D%2C%0A%20%20%22phoneNumbers%22%3A%20%5B%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22type%22%3A%20%22home%22%2C%0A%20%20%20%20%20%20%22number%22%3A%20%22212%20555-1234%22%0A%20%20%20%20%7D%2C%0A%20%20%20%20%7B%0A%20%20%20%20%20%20%22type%22%3A%20%22office%22%2C%0A%20%20%20%20%20%20%22number%22%3A%20%22646%20555-4567%22%0A%20%20%20%20%7D%0A%20%20%5D%2C%0A%20%20%22children%22%3A%20%5B%5D%2C%0A%20%20%22spouse%22%3A%20null%0A%7D"
            }[umlType];
            const samples = {
                plantUML: () => {
                    const sampleData = data;
                    $('#dataInput').val(decodeURIComponent(sampleData));
                    execBtn();
                }
            };

            samples['plantUML']();
        });

        $('#resetBtn').trigger('click');
    });

    function execBtn(opts) {
        opts = opts || {};
        $('#execBtn').trigger('click', opts);
    }

    function validate() {
        let isValid = true;
        const $input = $('#dataInput');

        if (!$input.val().replace(/[\t\s\n]/g, '')) {
            alert('내용을 입력해주세요.');
            $input.val('').focus();
            isValid = false;
        }
        return isValid;
    }

    function parseData({ inputText, view: { showDepth } }) {
        const replaceMultiNL = (txt) => txt 
                ? txt.replace(/(?<=")([\w\W\n]+)(?=")/g, (v) => v.replace(/\n/g, '\\n'))
                : '';
        const notEmpty = (s) => s && !/^[ \t\n]+$/.test(s);
        const removeTabTails = (s) => s.replace(/(.+[^\t])\t*$/, '$1');

        const reducer = (arr, txt) => {
            const str = removeTabTails(txt);
            const tabs = str.match(/^\t+/);
            const level = tabs ? tabs[0].length + 1 : 1;
            if (level == 1) ++topCnt;

            str.split(/\t+/).filter(notEmpty).forEach((val, idx) => {
                const depth = level + idx;
                arr.push({
                    show: depth <= showDepth || false,
                    depth,
                    value: val
                });
            });

            return arr;
        }

        let topCnt = 0;
        let data =
            replaceMultiNL(inputText)
                .split(/\n/)
                .filter(notEmpty)
                .reduce(reducer, []);

        return (topCnt > 1)
            ? [{ show: true, depth: 0, value: 'Root' }, ...data]
            : data;
    }

    const viewer = {
        default: plantUML,
        show: function (opts) {
            this[opts.view.type || this.default](opts);
        },
        plantUML
    };

    function plantUML(opts) {
        let uml = formatPlantUML(opts);
        window.uml = uml;
        const src = "https://www.plantuml.com/plantuml/svg/" + window.plantumlEncoder.encode(uml);
        $(opts.display).html($('<img>').attr('src', src));
    }

    function formatPlantUML(opts) {
        const formatData = getPlantUmlFormat(opts);
        const umlStyle = getPlantUmlStyle(opts);

        const { type, umlType, umlScale, nodeDepth } = opts.view;

        const uml =
            `@start${umlType}
            skinparam defaultFontSize ${umlScale}
            ${umlStyle}
            ${formatData}
            @end${umlType}`;

        return uml;
    };

    function getPlantUmlFormat(opts) {
        const func = {
            mindmap: ({ data, view: { umlType, countDepth, nodeDepth }}) => {
                const colorset = (depth) => ({
                    1: '[#ABBFFF]',
                    2: '[#E8BEFA]',
                    3: '[#FBCDF2]',
                    4: '[#FEE3E2]',
                    5: '[#FCF4C9]',
                    6: '[#FFFAE5]',
                    7: '[#FFFBEF]',
                })[depth] || '';

                const addStar = data[0].depth == 0? 1 : 0;

                return data.filter(d => d.show)
                    .map(d => {
                        let star = new Array(d.depth + addStar).fill('*').join('').trim();
                        star += (nodeDepth < d.depth)? '_' : `${colorset(d.depth)}`;

                        if (d.value.indexOf('\\n') > -1) {
                            d.value = '\\n' + d.value.replace(/^"([^"]+)"$/, '$1');
                        }

                        const depth = (countDepth) ? ` [${d.depth}]` : '';

                        let value = (d.value.indexOf('\\n') > -1)
                            ? '\\n' + d.value.replace(/^"([^"]+)"$/, '$1')
                            : d.value;

                        return `${star}${depth} ${value}`;
                    })
                    .join('\n');
            },
            wbs: function(opts) {
                return this.mindmap(opts);
            },
            json: ({ data }) => data
        };
        return func[opts.view.umlType](opts);
    }

    function getPlantUmlStyle(opts) {
        const func = {
            mindmap: (opts) => {
                const { umlScale } = opts.view;
                const rootFontColor = opts.data[0].depth == 0 ? 'white' : 'black';
                const thickness = umlScale <= 12 ? 0.3 : umlScale * 0.012 + 0.3;

                return `
                    <style>
                    node {
                        Padding 6
                        LineColor #919191
                        LineThickness 0.5
                        BackgroundColor #FFFFFF
                        RoundCorner 15
                        Shadowing 1
                    }

                    rootNode {
                        BackgroundColor #3D3D3D
                        FontColor ${rootFontColor}
                    }

                    arrow {
                        LineThickness ${thickness}
                        LineColor gray
                    }
                    </style>
                `;
            },
            wbs: function(opts) {
                return this.mindmap(opts);
            },
            json: (opts) => ''
        };
        
        return func[opts.view.umlType](opts);

        /* 적용시 mindmap 에서 Depth가 낮을때 오류가 발생하는 버그
        leafNode {
            BackgroundColor #FBF1D6
        }
        */
    };

    /* Polyfill */
    Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(t){if(null==this)throw new TypeError("this is null or not defined");for(var r=Object(this),e=r.length>>>0,i=arguments[1]>>0,n=i<0?Math.max(e+i,0):Math.min(i,e),i=arguments[2],i=void 0===i?e:i>>0,o=i<0?Math.max(e+i,0):Math.min(i,e);n<o;)r[n]=t,n++;return r}});
</script>
</body>
</html>
